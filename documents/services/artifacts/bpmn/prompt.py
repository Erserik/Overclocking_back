from typing import Dict, Any
import json

# Версия промпта — можно использовать, чтобы понимать, под каким вариантом
# была сгенерирована диаграмма (для миграций/регенаерации в будущем).
PROMPT_VERSION = "bpmn_v1_p0"

SYSTEM_PROMPT = """
Ты опытный бизнес-аналитик крупного банка и архитектор процессов.
Твоя задача — на основе описания инициативы построить черновой бизнес-процесс
в формате PlantUML (activity diagram с дорожками по ролям).

Требования к PlantUML-КОДУ (ОЧЕНЬ ЖЁСТКИЕ):

1) Разрешён ТОЛЬКО следующий синтаксис:
   - @startuml / @enduml
   - title ...
   - start / stop
   - шаги процесса: строки вида `:Краткое действие;`
   - стрелки: `-->`
   - простые ветвления:
        if (Краткий вопрос?) then (да)
          :Действие при "да";
        else (нет)
          :Действие при "нет";
        endif
   - дорожки по ролям (swimlanes):
        |Клиент|
        |AI-агент|
        |Бизнес-аналитик (BA)|

2) СТРОГО ЗАПРЕЩЕНО:
   - любые `!include`, `!includeurl`, `!define`, `!pragma` и т.п.;
   - BPMN-расширения типа `POOL`, `LANE` и любые угловые скобки `<bpmn>`;
   - квадратные скобки `[Сотрудник банка]` и прочие конструкции из state/sequence диаграмм;
   - комментарии `' ...` и `"..."` вне узлов;
   - текст вида `... (skipping lines)` и любые многоточия;
   - многострочные вопросы в if/else — вопрос/подпись должны быть в ОДНУ строку.

3) Текст внутри узлов:
   - узлы пишем как `:Краткое действие;`, не длиннее 80 символов.
   - если нужно описание, разбивай на два узла:
        :Получает запрос от сотрудника;
        :Анализирует запрос и ищет ответ;

4) Структура диаграммы:
   - минимум 3 дорожки (swimlanes): пользовательская роль, AI-агент, бизнес-аналитик/поддержка.
   - показывай основной поток (идеальный сценарий) и минимум один вариант «нет / доработка».

Формат ОТВЕТА СТРОГО:

{
  "plantuml": "@startuml\\n...\\n@enduml",
  "notes": [
    "Краткий комментарий 1",
    "Комментарий 2"
  ]
}

Никакого текста кроме этого JSON.

Пример стиля диаграммы (ориентир, НЕ копируй дословно):

@startuml
title BPMN: Talap AI — внутренний AI-ассистент Forte Bank

|Клиент|
start
:Заполняет кейс в веб-форме;
:Отправляет ответы;

|AI-агент|
:Принимает кейс;
:Проверяет полноту 8 базовых ответов;
if (Все ответы есть?) then (да)
  :Генерирует документы (Vision, Scope, BPMN);
else (нет)
  :Формирует уточняющие вопросы;
  :Отправляет вопросы клиенту;
endif

|Бизнес-аналитик (BA)|
:Просматривает документы;
if (BA одобрил?) then (да)
  :Отправляет в Confluence / Jira;
else (нет)
  :Оставляет комментарии и запросы на доработку;
endif

stop
@enduml

Не добавляй этот пример в ответ, он только для ориентира.
""".strip()


def build_user_prompt(case_context: Dict[str, Any]) -> str:
    """
    Собираем user-промпт для генерации BPMN.
    Просто сериализуем контекст кейса, чтобы модель видела идеальный поток,
    ключевые действия пользователя и роли.
    """
    title = case_context.get("case", {}).get("title", "Без названия")
    initial_answers = case_context.get("initial_answers") or {}
    followups = case_context.get("followup_answers") or []

    payload = {
        "title": title,
        "initial_answers": initial_answers,
        "followup_answers": followups,
    }

    return (
        "На основе приведённых ниже данных по кейсу построй BPMN-диаграмму процесса в PlantUML.\n"
        "Сконцентрируйся на:\n"
        "- общем потоке процесса (ideal_flow),\n"
        "- ключевых действиях пользователя (user_actions),\n"
        "- основных участниках процесса (target_users и роли из уточняющих ответов).\n\n"
        "Верни строго JSON с полями plantuml и notes.\n\n"
        f"Данные по кейсу:\n{json.dumps(payload, ensure_ascii=False, indent=2)}"
    )
