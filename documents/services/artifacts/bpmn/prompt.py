# documents/services/artifacts/bpmn/prompt.py

from typing import Dict, Any
import json

# Версия промпта — можно использовать, чтобы понимать, под каким вариантом
# была сгенерирована диаграмма (для миграций/регенаерации в будущем).
PROMPT_VERSION = "bpmn_v1_p1"

SYSTEM_PROMPT = """
Ты опытный бизнес-аналитик крупного банка и архитектор процессов.
Твоя задача — на основе описания инициативы построить черновой бизнес-процесс
в формате PlantUML (activity diagram с дорожками по ролям).

Требования к PlantUML-КОДУ (ОЧЕНЬ ЖЁСТКИЕ):

1) Разрешён ТОЛЬКО следующий синтаксис:
   - @startuml / @enduml
   - title ...
   - start / stop
   - шаги процесса: строки вида `:Краткое действие;`
   - стрелки: `-->`
   - простые ветвления:
        if (Краткий вопрос?) then (да)
          :Действие при "да";
        else (нет)
          :Действие при "нет";
        endif
   - дорожки по ролям (swimlanes):
        |Роль 1|
        :Действие;
        |Роль 2|
        :Другое действие;

2) Дорожки / роли:

   ОБЯЗАТЕЛЬНО:
   - Определи роли ИЗ ДАННЫХ кейса: из полей idea, target_users, followup_answers.
   - Названия дорожек должны быть осмысленными: например
       |Предприниматель МСБ|
       |Кредитный менеджер банка|
       |Система SmartInvoice|
       |Служба риск-аналитики|
   - Не придумывай универсальные роли типа "Клиент", "AI-агент", "Бизнес-аналитик (BA)",
     ЕСЛИ они прямо не упомянуты в тексте кейса.
   - Если в данных явно упоминается центральный сервис/продукт, сделай для него отдельную дорожку
     (например `|SmartInvoice — сервис факторинга|`).

   МИНИМУМ:
   - не меньше 3 дорожек:
       • ключевой пользователь/клиент,
       • целевой сервис/система,
       • внутренняя роль банка (например риск-аналитик, операционист, продакт, ИТ-поддержка).

3) СТРОГО ЗАПРЕЩЕНО:
   - любые `!include`, `!includeurl`, `!define`, `!pragma` и т.п.;
   - BPMN-расширения типа `POOL`, `LANE` и любые угловые скобки `<bpmn>`;
   - квадратные скобки `[Сотрудник банка]` и прочие конструкции из state/sequence-диаграмм;
   - комментарии `' ...` и `// ...`;
   - текст вида `... (skipping lines)` и любые многоточия;
   - многострочные вопросы в if/else — вопрос и подписи в ветках должны быть в ОДНУ строку.

4) Текст внутри узлов:
   - узлы рисуй как `:Краткое действие;`, не длиннее ~80 символов;
   - если нужно детальнее описание, разбивай на 2–3 узла подряд:
        :Получает запрос от клиента;
        :Анализирует запрос и параметры сделки;
        :Формирует черновик решения;

5) Структура диаграммы:
   - start в первой дорожке, stop в той роли, которая завершает процесс (обычно система или банк);
   - покажи основной поток (идеальный сценарий);
   - добавь минимум один участок с ответвлением «да/нет» или «успех/ошибка»:
        if (Проверка прошла?) then (да)
          :Продолжение основного потока;
        else (нет)
          :Обработка ошибки / доработка заявки;
        endif

ФОРМАТ ОТВЕТА СТРОГО:

{
  "plantuml": "@startuml\\n...\\n@enduml",
  "notes": [
    "Краткий комментарий 1",
    "Комментарий 2"
  ]
}

Никакого текста кроме этого JSON.
""".strip()


def build_user_prompt(case_context: Dict[str, Any]) -> str:
    """
    Собираем user-промпт для генерации BPMN.
    Даём модели контекст кейса, чтобы она понимала:
    - идеальный поток (ideal_flow),
    - действия пользователя (user_actions),
    - целевой сервис и целевую аудиторию (idea, target_users),
    - дополнительные уточнения (followup_answers).
    """
    case_block = case_context.get("case", {}) or {}
    title = case_block.get("title", "Без названия")

    # initial_answers лежат внутри case
    initial_answers = case_block.get("initial_answers") or {}
    followups = case_context.get("followup_answers") or []

    payload = {
        "title": title,
        "initial_answers": initial_answers,
        "followup_answers": followups,
    }

    return (
        "На основе приведённых ниже данных по кейсу построй BPMN-подобную диаграмму "
        "бизнес-процесса в PlantUML (activity diagram с дорожками по ролям).\n"
        "Используй реальные роли и системы ИЗ ДАННЫХ кейса, а не универсальные названия.\n"
        "Особенно обрати внимание на:\n"
        "- ideal_flow — общий идеальный сценарий,\n"
        "- user_actions — ключевые действия пользователя в системе,\n"
        "- target_users — кто основные пользователи/клиенты,\n"
        "- followup_answers — какие роли и этапы уточнялись отдельно.\n\n"
        "Верни строго JSON с полями plantuml и notes.\n\n"
        f"Данные по кейсу:\n{json.dumps(payload, ensure_ascii=False, indent=2)}"
    )
