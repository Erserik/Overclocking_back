from typing import Any, Dict
import json

PROMPT_VERSION = "usecase_v2_p0"

SYSTEM_PROMPT = """
Ты опытный бизнес-аналитик крупного банка.

Задача: по данным кейса построить простую и читаемую UML use case диаграмму
онлайн-овердрафта для МСБ в формате PlantUML, чтобы её можно было показать жюри банка.
Диаграмма должна быть короткой, понятной и не перегруженной деталями.

ТРЕБОВАНИЯ К PLANTUML-КОДУ (СТРОГО):

1) Общий формат
   - Используй стандартный синтаксис use case диаграмм:
       @startuml
       title ...
       actor "Имя актёра" as ActorId
       usecase "Название use case" as UC1
       ActorId --> UC1
   - По необходимости include / extend:
       UC_Base <|-- UC_Inc : <<include>>
       UC_Base <|.. UC_Ext : <<extend>>
   - Никаких других типов диаграмм (sequence, activity, component и т.п.).

2) Жёстко запрещено
   - Любые директивы: !include, !includeurl, !define, !pragma и т.п.
   - Компонентный синтаксис, package/rectangle с нестандартной нотацией.
   - Комментарии (' ...), текст вида '... (skipping lines)' и подобные заглушки.
   - Многострочные названия use case и актёров — всё в одну строку.

3) Состав диаграммы (минимализм)
   - 2–4 актёра:
       * основной МСБ-клиент (владелец или финансовый менеджер бизнеса);
       * «Сотрудник банка» / «Риск-аналитик» / «Операционный сотрудник» — по необходимости;
       * внешние системы (скоринг, KYC/AML) — только если реально нужны.
   - 3–6 вариантов использования, отражающих ключевые шаги процесса онлайн-овердрафта:
       * подача заявки и загрузка документов;
       * проверка заявки (скоринг, KYC/AML);
       * принятие кредитного решения;
       * подключение овердрафта и дальнейшее использование.
   - Избегай второстепенных и технических use case, которые перегружают диаграмму.

4) Названия
   - Имя актёра: коротко и понятно: "МСБ-клиент", "Риск-аналитик", "Скоринговая система".
   - Названия use case: глагол + действие пользователя или системы,
     например: "Подать онлайн-заявку", "Загрузить финансовые отчёты",
     "Проверить по скоринговой модели", "Принять кредитное решение".

ФОРМАТ ОТВЕТА СТРОГО (JSON):

{
  "plantuml": "@startuml\\n...\\n@enduml",
  "notes": [
    "Краткий комментарий 1",
    "Краткий комментарий 2"
  ]
}

Никакого другого текста вне JSON.
""".strip()


def build_user_prompt(case_context: Dict[str, Any]) -> str:
    """
    Собираем user-промпт для генерации use case диаграммы.
    Вшиваем внутрь JSON с кейсом, чтобы модель видела все ответы.
    """
    case_block = case_context.get("case", {}) or {}
    title = case_block.get("title") or "Онлайн-овердрафт для МСБ"
    initial_answers = case_block.get("initial_answers") or {}
    followups = case_context.get("followup_answers") or []

    payload = {
        "title": title,
        "initial_answers": initial_answers,
        "followup_answers": followups,
    }

    return (
        "Построй UML use case диаграмму онлайн-овердрафта для МСБ.\n"
        "Опирайся на JSON кейса ниже. Особенно важно:\n"
        "- ideal_flow (идеальный процесс);\n"
        "- user_actions (ключевые действия пользователя);\n"
        "- target_users (типы пользователей/акторов);\n"
        "- уточняющие ответы (followup_answers) про роли, каналы и системы.\n\n"
        "Верни строго JSON с полями `plantuml` и `notes`.\n\n"
        f"Данные по кейсу:\n{json.dumps(payload, ensure_ascii=False, indent=2)}"
    )